\section{Materials \& Methods}

\subsection*{Animals}
We used adult male mice with C57BL/6J genetic background. Mice were housed in groups of 3--5, in 12-h/12-h light-dark cycle (lights off at 19:00), and most experiments were performed in late afternoons and evenings (16:00--midnight). At the start of experiments, mice were P51--117. No statistical tests were used to predetermine sample sizes, but sample sizes for this study are similar to those generally employed in the field. All experimental procedures were approved by the Institutional Animal Care and Use Committee, Yale University.

\subsection*{Surgery}
Mice underwent two surgeries. For each surgery, the mouse was anesthetized with 2\% isoflurane in oxygen during induction, which was then lowered to 1–1.5\% for the remainder of the surgery. The mouse was placed over a water-circulating heating pad (TP-700, Gaymar Stryker) in a stereotaxic frame (David Kopf Instruments). Before the operation, the mouse was injected with carprofen (5 mg/kg, s.c.; \#024751, Butler Animal Health) and dexamethasone (3 mg/kg, s.c.; Dexaject SP, \#002459, Henry Schein Animal Health). The mouse was injected with carprofen immediately after surgery (5 mg/kg, s.c.) and each day for the following 3 d (5 mg/kg, s.c.). 

For the first surgery, an incision was made to expose the skull. Based on stereotaxic coordinates, the center location of the mouse secondary motor cortex (M2; AP 1.5 mm and ML $-0.5$ mm relative to bregma) was marked over the right hemisphere. In other experiments, we targeted the anterior-lateral motor cortex (ALM; AP 2.5 mm, ML $-1.5$ mm) or the primary visual cortex (V1; AP $-3.8$ mm, ML 2.0 mm) in the right hemisphere. A stainless steel head plate (eMachineshop) was affixed to the skull with Metabond (C\&B, Parkell, Inc.), and a thin layer of clear Metabond was then applied to cover the entire skull. Mice were given at least 1 week to recover before behavioral training (see below). 

Once mice reached a performance criterion of $>90\%$ correct rate on three consecutive days and was ready for imaging experiments, a second surgery was performed under anesthesia. Using a dental drill, a 3-mm-diameter craniotomy was made at the target location, which had been marked previously and remained visible through the Metabond. Dura was left intact and was irrigated with artificial cerebrospinal fluid (aCSF, in mM: 5 KCl, 5 HEPES, 135 NaCl, 1 MgCl2, 1.8 CaCl2; pH 7.3). 

Using a glass micropipette attached to a microinjection system (Nanoject II, Drummond), 32--46 nL of AAV1-Syn-GCaMP6s-WPRE-SV40 ($5 \times 10^{13}$ titer; UPenn Vector Core) was injected at a depth of 400 \unit{\micro\meter} below dura at each of four locations: the vertices of a square 200 \unit{\micro\meter} wide, centered on the target coordinates. The glass micropipette was left in place for 5 min after injection to reduce backflow. A drop of warmed agarose solution (1.2\% in ACSF, Type III-A, High EEO, A9793, Sigma-Aldrich) was then applied to the cortical surface. 

A two-layer glass window was fabricated by first etching out a 2-mm-diameter circle from \#0 thickness glass cover slip, then bonding with UV-activated polymer (61, Norland Optical Adhesive) to a \#1 thickness, 3-mm-diameter round glass cover slip (64-0720 CS-3R, Warner Instruments). This glass window was then placed against the cortical surface. While applying light pressure, cyanoacrylate glue was added to the rim to attach the glass to the skull and Metabond. Mice were again given at least 1 week to recover before resuming behavioral training. Imaging experiments began when behavioral performance criterion was reached. 

Eight of 11 mice went through this procedure involving two surgeries. For the remaining three mice, the head plate implant, viral injection and window implant procedures were performed in the same surgery before behavioral training.

\subsection*{Behavioral Setup}
For head-fixed mouse behavior, we used a training apparatus with two lick ports, thus enabling two alternative choices \citep{guo2014flow}. Two metal screws were used to affix the head plate of the mouse onto a stainless steel mount. The mouse was then restrained inside an acrylic tube, which restricted gross body movements but allowed postural adjustments. 

The lick ports were fabricated from stainless steel 20-gauge needles, which were positioned at $90 \degree$ and $270 \degree$ with respect to the mouse's head orientation, and held in place by a 3D-printed plastic part mounted on a micromanipulator for fine positional adjustment. Water was delivered at the ports by gravity feed and the liquid volume was controlled by pneumatic valves (EV-2-24, Clippard) calibrated with an intravenous dripper to deliver $\sim 2$ \unit{\micro\liter} per pulse. A battery-operated touch detector circuit signaled when the mouse's tongue contacted a lick port. 

Auditory stimuli were played through computer speakers placed directly in front of the animal. The intensity of the auditory stimuli was calibrated to $\sim 85$ dB peak amplitude. 

Water delivery, lick detection and sound presentation were connected to a desktop computer via a data acquisition board (USB-201, Measurement Computing). Presentation software (Neurobehavioral Systems) controlled the entire behavioral system.

Behavioral training was performed inside the closed compartment of an audio-visual cart that was dark and soundproofed with acoustic foam (5692T49, McMaster-Carr). An infrared webcam was used to monitor the animal while in the rig. For imaging, mice were tested using a replica of the behavioral training setup under a two-photon microscope.

\subsection*{Adaptive Decision-Making Task}
To motivate participation in the task, water consumption was restricted to behavioral sessions. Mice were trained for 1 session per day, 6 d per week. On the non-training day, water was provided \textit{ad libitum} in the home cage for 15 min. 

The mice were trained through four phases to shape their behavior. Phase one ($\sim 2$ d): mice were habituated to head fixation in the behavior box and trained to lick either one of the two ports for water reward. Mice were advanced to the next phase when they made $>100$ responses in a session. 

Phase two ($\sim 2$ d): mice were trained to sample both ports. Here mice were required to lick the left port to obtain water rewards three times, followed by the right port for the next three rewards, and so on. Mice were advanced to the next phase when they made $> 100$ correct responses in a session. 

Phase three ($>15$ d): animals underwent training for two-choice auditory discrimination. One of two auditory cues was presented to begin each trial---a 2-s-long train of 0.5-s-long logarithmic frequency modulated sweeps from 5 to 15 kHz (`upsweep') or from 15 to 5 kHz (`downsweep'). These stimuli were interleaved randomly from trial to trial. At 0.5 s following the onset of the auditory cue, a response window opened, lasting for a duration of 1.5 s. The first lick within this response window was registered as its response for the trial. All other licks were logged but had no consequences. Once a response was recorded, playback of the auditory cue was terminated. 

A correct response, i.e., a left lick for upsweep or a right lick for downsweep, resulted in immediate delivery of 2 \unit{\micro\liter} of water from the corresponding port. The next trial would begin 7 s following response. Incorrect responses resulted in 2 s of white noise presentation, with the next trial beginning 5 s later. Thus, each trial had a total duration within a range from 7.5 to 9 s. Animals were allowed to perform trials until satiated (20 consecutive misses), typically after $\sim 60$ min. 

Training continued daily until a correct rate of $>90\%$ was attained for 3 consecutive days. For imaging experiments, mice were then trained under the two-photon microscope (with laser turned off) for habituation to the recording setup. All mice were able to discriminate at $>90\%$ correct rate after 1--3 d of re-training. 

Finally, mice were tested on the adaptive decision-making task. The task always began with a sound block (S) indistinguishable from the two-choice auditory discrimination task. However, once the mouse reached a performance criterion of $>85\%$ correct for the last 20 trials, the stimulus–response-outcome contingencies changed from being sound- to action-guided. In action-guided trials, task structure was identical to sound-guided trials. However, the correct response became fixed to one response direction, for example, always left, regardless of the stimulus identity. No cue signaled the change in contingencies. 

When the mouse reached performance criterion again, another block switch occurred. A sound block was always followed by an action block and vice versa. The second block was randomly chosen for each experiment to be action-left (AL) or action-right (AR). However, once the first action block was chosen, the block sequence became fixed for the remainder of the session. Therefore, the sequence of blocks could be one of two possibilities: (S-AL-S-AR-S- \ldots) or (S-AR-S-AL-S \ldots). 

Each session was terminated after 20 consecutive misses (trials with no response). Mice typically performed the adaptive decision-making task for 60--90 min. Following each adaptive decision-making test, mice resumed daily two-choice auditory discrimination until the next recording session, up to a maximum of 7 adaptive decision-making tests.

\subsection*{Two-Photon Calcium Imaging}
The two-photon microscope (Movable Objective Microscope, Sutter Instrument) was controlled using ScanImage software51. The excitation source was a Ti:Sapphire femtosecond laser (Chameleon Ultra II, Coherent). Excitation intensity was controlled by a Pockels cell (350-80-LA-02, Conoptics) and focused onto the sample with a $20\times$, N.A. 0.95 water immersion objective (Olympus). The time-averaged excitation laser intensity was 90--100 mW after the objective. 

To image fluorescence transients from GCaMP6s-expressing neurons, excitation wavelength was set at 920 nm, and emission was collected from 475--550 nm with a GaAsP photomultiplier tube. Time-lapse images were acquired at a resolution of $256 \times 256$ pixels and a frame rate of 3.62 Hz using bidirectional scanning. To synchronize behavior with imaging, a TTL pulse was sent at the beginning of each trial from the data acquisition board of the behavioral system to the imaging system to act as an external trigger for initiating image acquisition.

\subsection*{Neural Inactivation}
Mice were implanted with a head plate. The locations of M2 were marked on both hemispheres (AP 1.5 mm, ML $-0.5$ mm), and then covered with a thin layer of clear Metabond. Mice were then trained as described above, in preparation for the adaptive decision-making test. 

On the first day of testing, craniotomies were performed at the marked locations. Using a glass micropipette attached to a microinjection system (Nanoject II, Drummond), aCSF, with or without muscimol (5 mM, 46 nL per hemisphere; cat. \#195336, MP Biomedical), was injected at a depth of 400 \unit{\micro\meter} into M2 of both hemispheres. Behavioral testing began 1--3 h following injection. 

The same mice were tested after saline and muscimol treatments on consecutive days in a counter-balanced design, with no blinding. The mice were randomized to receive either saline or muscimol first in an alternating manner depending on the order in which they reached the behavioral performance criterion. Twelve mice were allocated for this experiment; however, one was excluded due to equipment malfunction during testing.

\subsection*{Histology}
Following experiments, mice were transcardially perfused with chilled formaldehyde solution (4\% in phosphate-buffered saline). The brains were sectioned with a vibratome and imaged with an inverted wide-field fluorescence microscope.

\subsection*{Analysis of Behavioral Data}
Timestamps of stimulus presentation, licks and water delivery were logged in a text file by Presentation software (Neurobehavioral Systems, Inc.). Scripts were written in MATLAB to parse the log files. 

`Perseverative errors' were defined as incorrect responses that would have been correct according to the contingencies of the last block of trials. For example, during an action-left block, the stimulus–response pairings of upsweep–left lick and downsweep–left lick would be `correct'. Downsweep–right lick would be a perseverative error, because this stimulus–response pairing would have been correct in the preceding sound-guided block. The remaining possible stimulus–response pairing, upsweep–right lick, would be classified as an `other error'. 

The number of trials performed included all correct and error trials, but excluded `miss' trials where the mouse failed to lick within the response window. Miss trials typically occurred near the end of the session when the mouse was satiated. 

The number of trials to criterion was defined as the number of trials performed in a certain trial block before reaching a performance criterion of 85\% correct for the last 20 trials. Therefore, the minimum value of this quantity is 20. 

Mean trials to criterion for each session was calculated excluding the first sound block, because contingency switches had not yet begun. Mean blocks per 100 trials, mean perseverative errors per block and mean other errors per block were calculated excluding the last block (i.e., trials after the last block switch). We often compared conditions before and after block switches, which were defined as the 20 trials before or following a block switch. 

The first lick time was defined as the time of the first lick after sound onset for each trial, even if this occurred before the start of the response window. The first lick time is thus a sum of the reaction time and movement time. For this measurement, we excluded trials in which the mouse licked within 0.5 s before cue onset, in which case the first lick may represent the continuation of a spontaneous lick bout rather than a reaction to the stimulus.

\subsection*{Analysis of Imaging Data}
Time-lapse fluorescence images were first corrected for x–y motion using the TurboReg plug-in \citep{thevenaz1998pyramid} for ImageJ \citep{schneider2012nih}. 

We wrote a graphical user interface in MATLAB to select cell bodies as regions of interest (ROIs). Values of pixels within an ROI were averaged within each frame to yield the cellular fluorescence measurement $F_C(t)$. For each cell, we estimated the neuropil signal by approximating the ROI area as a circle to estimate a radius $r$ \citep{peron2015cellular}, then creating an annulus-shaped neuropil area with inner and outer radii of $2r$ and $3r$. This neuropil area excluded pixels if they were part of the ROI of another cell body. Values of pixels within the annulus-shaped neuropil area were averaged to generate $F_N(t)$. To subtract the neuropil signal, we calculated $F(t) = F_C(t) - \alpha F_N(t)$, where $\alpha$ is a correction factor ranging from 0.2 to 0.6. The value of $\alpha$ was calibrated for each experiment to avoid overcorrection, by making sure that $F(t) > 0$ for each cell. 

For each ROI, the fractional change in fluorescence, $\Delta F/F (t)$, was calculated as

\begin{equation*}
    \frac{\Delta F}{F}(t) = \frac{F(t)-F_0(t)}{F_0(t)}
\end{equation*}

\noindent where $F_0(t)$ is the baseline fluorescence as a function of time. 

To estimate baseline, we first obtained $F_{image}(t)$, the mean pixel intensity for the entire $256 \times 256$ pixel field of view as a function of time. $F_0(t)$ was then calculated as

\begin{equation*}
    F_0(t) = F^{*} \times \frac{F_{0,image}(t)}{F^*_{0,image}}
\end{equation*}

\noindent where $F_{0,image}(t)$ is the 10th percentile of $F_{image}(t)$ within a sliding window of 10 min duration. $F^*$ and $F^*_{0,image}$ are the 10th percentile of $F(t)$ and $F_{0,image}(t)$ within the first 10 min of the session, respectively. We verified that $F_{0,image}(t)/F^*_{0,image}$ does not vary with specific choices or rule blocks, and thus serves the purpose of compensating for slow, full-field signal drifts due to non-physiological sources. 

We repeated the ensemble analyses with two other methods for calculating baseline: firstly, estimating $F_0(t)$ using the 10th percentile of $F(t)$, on a per-cell basis, with a moving window of 10 min duration; and secondly, estimating $F_0(t)$ using the 10th percentile of $F(t)$ from the entire session, i.e., without a moving window. These different ways to estimate baseline led to qualitatively similar results for all the ensemble analyses.

\subsection*{Analysis of Task-Related Activity and Choice Encoding}
To calculate trial-averaged fluorescence transients, we created time bins that were 0.5 s wide and assigned each $\Delta F/F (t)$ value at a particular time $t$ to the corresponding time bin relative to the animal's response. The binned $\Delta F/F (t)$ values were averaged to obtain trial-averaged $\Delta F/F (t)$. To estimate the uncertainty of the trial-averaged $\Delta F/F (t)$, a bootstrap analysis was performed by drawing fluorescence transients per trial, with replacement, up to the same number used to construct the trial average. The median and 95\% confidence intervals of trial-averaged $\Delta F/F (t)$ were estimated from 1,000 iterations of this bootstrap analysis. 

To quantify choice encoding, we performed multiple linear regression analysis on the $\Delta F/F (t)$ of each cell using the following equation:

\begin{equation*}
\frac{\Delta F}{F}(t) = a_0 + a_1 C_{n} + a_2 C_{n-1} + a_3 C_{n} C_{n-1} + a_4 C_{n-2} + \epsilon(t),\\
\end{equation*}

\noindent where $C_n$ is the choice made in the current trial, $C_{n-1}$ is the choice from the prior trial, $C_{n-2}$ is the choice from two trials ago, $\epsilon (t)$ is the error term, and $a_0 \ldots a_n$ are the regression coefficients. Left choices were coded as 1 and right as $-1$. 

A cell was deemed to encode one of the choice parameters or their interaction if $P < 0.01$ for the corresponding regression coefficient. To avoid confounds from rule and reward signals, we analyzed only sound-guided trials in which the outcomes of the current trial and prior trial were both reward. We did not analyze action trials because parameters such as $C_n$ and $C_{n-1}$ were highly correlated by virtue of the task structure---thus breaking a primary assumption underlying this type of analysis.

\subsection*{Analysis of Neural Ensemble Trajectories}
For state-space analyses, we used demixed principal component analysis \citep{machens2010functional} (dPCA). To prepare the imaging data for dPCA, we aligned $\Delta F/F$ traces from the first six seconds of each trial following the response. This alignment produced an array with dimensions ($cells \times time \times trials$). We then averaged across four trial types: $C_n = 1$ for pre-switch sound trials; $C_n = -1$ for pre-switch sound trials; $C_n = 1$ for pre-switch action trials; and $C_n = -1$ for pre-switch action trials---in all cases using only rewarded trials. This trial-averaged array ($cells \times time \times 4$) was input into the dPCA algorithm to demix time- and task-dependent variances and obtain principal components (PCs). 

To calculate neuronal trajectories, single-trial or trial-averaged $\Delta F/F$ traces were projected onto the first three PCs. To characterize similarities between trajectories across blocks, we calculated the trajectory for each block using the trial-averaged fluorescence across the 20 trials prior to the rule switch. 

The similarity between a pair of trajectories was quantified by calculating the mean Euclidean distance between trajectories at matching time points in state space. For pooled comparisons across experiments, the Euclidean distances were normalized by the dispersion population vectors from the corresponding experiment, calculated as the root mean square of the distances between all population vectors and the centroid of the vectors. 

To quantify how neural ensemble trajectories evolved on a trial-to-trial basis, we used the Mahalanobis distance, which is a measure of distance between one point and another collection of points. We defined the origin and destination as the population activity from the 20 trials preceding the current rule switch and the next rule switch, respectively. We were interested in the relative separation between the origin, an individual trial that occurred in between, and the destination. Therefore, for each time point within a trial, we calculated Mahalanobis distances, $d_{origin}(t)$ and $d_{dest}(t)$, from the corresponding population activity vector (one three-dimensional value) to those of the origin and destination, respectively (20 three-dimensional values each, estimated as the median across time for each trial). For each individual trial $n$, $d_{origin}(n)$ and $d_{dest}(n)$ were then estimated as the median distances for the $\sim 30$ time points within a trial. 

The location of an individual trial relative to the origin and destination was estimated as the ratio of Mahalanobis distances, $d_{origin}(n)/(d_{origin}(n) + d_{dest}(n)$). To summarize the relationship between this distance ratio and the number of trials from the rule switch, we then fit a logistic function,

\begin{equation*}
f(x) = \frac{L}{1+e^{-k(x-x_0)}} + L_{min}
\end{equation*}

\noindent where $x_0$ is the midpoint trial, $k$ is the steepness, $L$ is the range, and $L_{min}$ is the minimum value. The parameter $L_{min}$ was not fitted, but rather was estimated for each transition by calculating the mean Mahalanobis distance ratio using the five trials prior to each rule switch. 

We fit every neural ensemble transition using this method, but excluded those in which the midpoint trial $x_0 < -5$ or $x_0 > 200$, indicating a poor fit. Based on this criterion, we excluded none (0/33) of the action-to-sound shifts and 8\% (3/38) of the sound-to-action shifts in our analysis of M2 neural ensembles. For analysis of the ALM data set, we excluded 8\% (2/26) of the action-to-sound shifts and 3\% (1/32) of the sound-to-action shifts. 

When comparing behavioral and neural transitions, we defined `behavioral transition trial' as the number of trials to criterion (85\% correct for 20 consecutive trials) minus 20, i.e. the first in a series of 20 trials preceding the rule switch. The `neural transition trial' was defined as the trial when the first term of the logistic fit reached a value of 75\% $L$. That is, the trial $x$ that satisfies this equation:

\begin{equation*}
0.75L = \frac{L}{1+e^{-k(x-x_0)}}
\end{equation*}

This definition was arbitrary because it was unknown how much the population activity pattern must resemble the final pre-switch ensemble state in order to qualify as a transition. Therefore, in another analysis we first fit each neural transition with the logistic function and identified the behavioral trial corresponding to each 5\% $L$ step of neural transition from 10 to 90\% $L$. We then calculated the mean hit and error rates at the corresponding behavioral trials. The analysis provided a second description of the relationship between behavioral performance and neural transition without explicitly defining a transition trial.

\subsection*{Decoding population activity}
To determine how accurately trial type could be predicted from the ensemble activity, we gathered imaging frames that occurred between 0 to 6 s from time of response out of the frame-by-frame imaging data (i.e., $\Delta F/F (t)$). We then projected these $\Delta F/F (t)$ values onto the PCs determined from dPCA to obtain population activity vectors. This procedure reduced the dimensionality of our data from ($frames \times cells$) to ($frames \times 3$). 

Population activity vectors in this analysis were sampled from the last 20 trials of completed sound, action-left, or action-right blocks, and restricted to rewarded trials. Other trial types were not considered for the decoding analysis. We trained classifiers on a randomly chosen fraction (80\%) of the population activity vectors. Classifiers were based on linear discriminant analysis, using Mahalanobis distances with stratified covariance estimates (the `classify' function in MATLAB with `Mahalanobis' option). We then tested the performance of each classifier on the remaining 20\% of the population activity vectors, comparing classification results with actual trial types. This five-fold cross-validation process was repeated 1,000 times to obtain a median estimate of classifier accuracy. 

%***Resume initial formatting here (paragraph breaks, etc.)***
To investigate decoding accuracy across time, the timing information of each population activity vector relative to the time of response in each trial was retained. We then ran a separate decoding analysis on the population activity vectors measured during each time period, using a non-overlapping sliding window with duration of 0.28 s and step size of 0.28 s. This window duration is the inverse of frame rate, which was 3.6 Hz. To decode from single-cell activity, $\Delta F/F (t)$ of each cell was used instead of population activity vectors as inputs to construct the classifier.

\subsection*{Statistics}
Statistical tests were performed in MATLAB and are indicated in the main text or figure legends. Unless otherwise noted, a Wilcoxon signed-rank test was used for all paired comparisons. For two-sample, unpaired comparisons, a Wilcoxon rank-sum test was used. Paired t-tests were used for bin-wise analysis of lick rates. For quantification of choice signals as a function of time, multiple linear regression was first performed as detailed above; a binomial test was then applied to the proportion of cells significantly encoding choice within each time-bin. For ensemble decoding analyses, mean classification accuracy was tested against chance level using a one-sample t-test. For t-tests, the sampling distribution of the mean was assumed to be normal, but this was not formally tested. All t-tests were two-tailed.